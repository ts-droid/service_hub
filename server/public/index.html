<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f6f7fb; font-family: 'Segoe UI', sans-serif; }
    .ticket-card { border-left: 5px solid #0d6efd; cursor: pointer; transition: 0.2s; position: relative; border-radius: 8px; }
    .ticket-card:hover { transform: translateX(5px); background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .ticket-meta { font-size: 0.85rem; color: #6c757d; }
    .history-container { max-height: 350px; overflow-y: auto; background: #fff; border-radius: 8px; padding: 15px; border: 1px solid #eee; }
    .ai-box { background: #e7f5ff; border: 1px solid #a5d8ff; border-radius: 8px; padding: 15px; font-style: italic; }
    .locked-badge { font-size: 0.7rem; background: #ffec99; color: #862e12; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .group-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 999px; font-weight: 700; }
    .group-support { background: #e7f5ff; color: #1864ab; }
    .group-rma { background: #fff4e6; color: #d9480f; }
    .group-logistics { background: #ebfbee; color: #2b8a3e; }
    .group-finance { background: #eef2ff; color: #3730a3; }
    .group-marketing { background: #fff0f6; color: #a61e4d; }
    .group-sales { background: #f8f0fc; color: #862e9c; }
    .group-default { background: #f1f3f5; color: #495057; }
    .status-wait { background-color: #6f42c1 !important; color: white; }

    .priority-alert {
      position: absolute; top: 10px; right: 10px;
      background: #ff4136; color: white; font-size: 0.65rem;
      padding: 2px 8px; border-radius: 10px; font-weight: bold;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .main-tabs { padding: 10px; gap: 8px; }
    .main-tabs .nav-item { flex: 1 1 0; }
    .main-tabs .nav-link {
      cursor: pointer;
      color: #495057;
      font-weight: 700;
      border: 1px solid #dfe3ee;
      border-radius: 10px;
      padding: 10px 14px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .main-tabs .nav-link.active {
      color: #0d6efd;
      border-color: #0d6efd;
      background: #edf4ff;
      box-shadow: inset 0 0 0 1px rgba(13,110,253,0.1);
    }
    .tab-count {
      min-width: 30px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.78rem;
      font-weight: 700;
      text-align: center;
      background: #f1f3f5;
      color: #495057;
    }
    .main-tabs .nav-link.active .tab-count {
      background: #0d6efd;
      color: #fff;
    }

    .msg-bubble { margin-bottom: 15px; padding: 10px; border-radius: 8px; background: #f8f9fa; border: 1px solid #f1f1f1; }
    .msg-header { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 5px; color: #0d6efd; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark p-3 shadow-sm">
    <div class="container d-flex justify-content-between">
      <span class="navbar-brand fw-bold">Vendora Support Hub</span>
      <div id="topActions" class="d-flex gap-2"></div>
    </div>
  </nav>

  <div class="container mt-4">
    <ul class="nav nav-tabs mb-4 border-0 shadow-sm bg-white rounded main-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-status="Nytt" onclick="setTab(this, 'Nytt')"><span>Nytt</span><span id="countNytt" class="tab-count">0</span></a></li>
      <li class="nav-item"><a class="nav-link" data-status="Mina PÃ¥gÃ¥ende" onclick="setTab(this, 'Mina PÃ¥gÃ¥ende')"><span>Mina PÃ¥gÃ¥ende</span><span id="countMinaPagaende" class="tab-count">0</span></a></li>
      <li class="nav-item"><a class="nav-link" data-status="VÃ¤ntar" onclick="setTab(this, 'VÃ¤ntar')"><span>VÃ¤ntar</span><span id="countVantar" class="tab-count">0</span></a></li>
      <li class="nav-item"><a class="nav-link" data-status="LÃ¶st" onclick="setTab(this, 'LÃ¶st')"><span>LÃ¶st</span><span id="countLost" class="tab-count">0</span></a></li>
    </ul>

    <div class="row g-2 mb-3 align-items-center">
      <div class="col-md-4">
        <label class="small fw-bold text-muted ms-1">Filter Grupp:</label>
        <select id="filterGroup" class="form-select shadow-sm" onchange="refresh()"></select>
      </div>
      <div class="col-md-2 mt-auto">
        <button class="btn btn-primary w-100 shadow-sm" onclick="refresh()">Uppdatera</button>
      </div>
    </div>

    <div id="ticketContainer" class="row">Laddar Ã¤renden...</div>
  </div>

  <div class="modal fade" id="ticketModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg border-0">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title fw-bold" id="mSubject">Ã„rende</h5>
          <button type="button" class="btn-close" onclick="closeModalCleanly()"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-4 p-2 bg-light rounded">
            <div class="d-flex gap-2 align-items-center">
              <span class="small fw-bold text-muted">Flytta till:</span>
              <select id="mGroup" class="form-select form-select-sm w-auto">
                <option value="SUPPORT">SUPPORT</option>
                <option value="RMA">RMA</option>
                <option value="FINANCE">FINANCE</option>
                <option value="LOGISTICS">LOGISTICS</option>
                <option value="MARKETING">MARKETING</option>
                <option value="SALES">SALES</option>
              </select>
              <span id="mCurrentGroupBadge" class="group-badge group-default">-</span>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <span class="small fw-bold text-muted">Tilldela:</span>
              <select id="mAssignee" class="form-select form-select-sm w-auto"></select>
              <button class="btn btn-sm btn-primary" onclick="doMove()">Spara & Flytta</button>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-danger btn-sm" onclick="doBlock()">Blockera</button>
              <button class="btn btn-outline-success btn-sm" onclick="doDelete()">Markera LÃ¶st</button>
            </div>
          </div>

          <div id="mHistory" class="history-container mb-3 shadow-sm"></div>

          <label class="small fw-bold mb-1 text-primary">AI SvarsfÃ¶rslag (OpenAI):</label>
          <div id="mAi" class="ai-box mb-3 small text-muted shadow-sm">AI tÃ¤nker...</div>

          <textarea id="mReply" class="form-control shadow-sm mb-2" rows="5" placeholder="Skriv ditt svar... ID inkluderas automatiskt."></textarea>
        </div>
        <div class="modal-footer bg-light border-0">
          <button class="btn btn-success w-100 fw-bold shadow-sm p-3" onclick="doReply()">SKICKA SVAR</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const esc = (s) => String(s || "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    let activeId = null;
    let currentSenderEmail = "";
    let currentStatusTab = "Nytt";
    let geminiConfigured = false;
    let currentUserGroups = [];
    let assignableUsers = [];
    const tModal = new bootstrap.Modal(document.getElementById('ticketModal'));
    const formatDateTime = (v) => {
      if (!v) return "";
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString('sv-SE');
    };
    const groupClass = (group) => {
      const g = String(group || '').toUpperCase();
      if (g === 'SUPPORT') return 'group-support';
      if (g === 'RMA') return 'group-rma';
      if (g === 'LOGISTICS') return 'group-logistics';
      if (g === 'FINANCE') return 'group-finance';
      if (g === 'MARKETING') return 'group-marketing';
      if (g === 'SALES') return 'group-sales';
      return 'group-default';
    };

    async function api(path, opts = {}) {
      const res = await fetch(path, { ...opts, credentials: 'include', headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) } });
      if (res.status === 401) {
        window.location.href = '/auth/google';
        return null;
      }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Request failed');
      }
      return res.json();
    }

    window.onload = async () => {
      const me = await api('/me');
      if (!me) return;
      geminiConfigured = !!me.geminiConfigured;
      currentUserGroups = String(me.group || '').split(',').map(s => s.trim()).filter(Boolean);
      const actions = [];
      if (me.isAdmin) {
        actions.push(`<a href="/admin" class="btn btn-warning btn-sm fw-bold shadow-sm">Admin</a>`);
      }
      actions.push(`<a href="/auth/logout" class="btn btn-outline-light btn-sm fw-bold shadow-sm">Logga ut</a>`);
      document.getElementById('topActions').innerHTML = actions.join('');
      if (!geminiConfigured) {
        document.getElementById('mAi').innerText = 'AI inte konfigurerad: sÃ¤tt OPENAI_API_KEY i Railway Variables.';
      }
      loadFilters();
    };

    function setTab(el, status) {
      document.querySelectorAll('#mainTabs .nav-link').forEach(link => link.classList.remove('active'));
      el.classList.add('active');
      currentStatusTab = status;
      refresh();
    }

    async function loadFilters() {
      const data = await api('/groups');
      if (!data) return;
      document.getElementById('filterGroup').innerHTML = data.groups.map(g => `<option value="${g}">${esc(g)}</option>`).join('');
      if (currentUserGroups.length === 1) {
        const onlyGroup = currentUserGroups[0].toUpperCase();
        const select = document.getElementById('filterGroup');
        const hasOption = Array.from(select.options).some(o => String(o.value).toUpperCase() === onlyGroup);
        if (hasOption) select.value = onlyGroup;
      }
      await refresh();
    }

    async function refreshTabCounts() {
      const group = document.getElementById('filterGroup').value;
      const qs = new URLSearchParams({ group }).toString();
      const stats = await api(`/tickets/stats?${qs}`);
      if (!stats) return;
      document.getElementById('countNytt').innerText = stats['Nytt'] || 0;
      document.getElementById('countMinaPagaende').innerText = stats['Mina PÃ¥gÃ¥ende'] || 0;
      document.getElementById('countVantar').innerText = stats['VÃ¤ntar'] || 0;
      document.getElementById('countLost').innerText = stats['LÃ¶st'] || 0;
    }

    async function refresh() {
      const filters = { group: document.getElementById('filterGroup').value, status: currentStatusTab };
      const qs = new URLSearchParams(filters).toString();
      const [tickets] = await Promise.all([
        api(`/tickets?${qs}`),
        refreshTabCounts()
      ]);
      if (!tickets) return;

      const container = document.getElementById('ticketContainer');
      if (!tickets.length) {
        container.innerHTML = '<div class="text-center p-5 text-muted"><h4>ðŸŽ‰</h4>Inga Ã¤renden hÃ¤r just nu.</div>';
        return;
      }
      container.innerHTML = tickets.map(t => `
        <div class="col-12 mb-2">
          <div class="card p-3 shadow-sm border-0 ticket-card" onclick="openTicket('${esc(t.ID)}', '${esc(t.Subject)}', '${esc(t.Sender)}')">
            ${t.Priority === 'NYTT SVAR' ? '<div class="priority-alert">NYTT SVAR</div>' : ''}
            <div class="d-flex justify-content-between align-items-center">
              <div class="pe-5">
                <h6 class="mb-1 fw-bold">${esc(t.Subject)}</h6>
                <div class="ticket-meta">
                  <span class="text-dark fw-medium">${esc(t.Sender)}</span> â€¢ ${esc(t.ID)}
                  ${t.CreatedAt ? `<span class="ms-2">â€¢ Inkommen: ${esc(formatDateTime(t.CreatedAt))}</span>` : ''}
                  ${t.Group ? `<span class="ms-2 group-badge ${groupClass(t.Group)}">${esc(t.Group)}</span>` : ''}
                  ${t.Owner ? `<span class="ms-2 locked-badge">ðŸ”’ ${esc(t.Owner.split('@')[0])}</span>` : ''}
                </div>
              </div>
              <div class="badge ${t.Status === 'PÃ¥gÃ¥r' ? 'bg-warning text-dark' : (t.Status === 'VÃ¤ntar' ? 'status-wait' : 'bg-primary')} shadow-sm">${esc(t.Status)}</div>
            </div>
          </div>
        </div>`).join('');
    }

    async function loadAssignableUsers() {
      const users = await api('/users/assignees');
      if (!users) return;
      assignableUsers = users;
      const select = document.getElementById('mAssignee');
      const options = ['<option value="">Ej tilldelad</option>'].concat(
        users.map(u => `<option value="${esc(u.email)}">${esc(u.name || u.email)} (${esc(u.email)})</option>`)
      );
      select.innerHTML = options.join('');
    }

    async function openTicket(id, subject, sender) {
      activeId = id;
      currentSenderEmail = sender;
      document.getElementById('mSubject').innerText = subject;
      document.getElementById('mHistory').innerHTML = '<div class="p-3 text-center text-muted">Laddar historik...</div>';
      document.getElementById('mAi').innerText = "OpenAI analyserar och tar fram ett svarsfÃ¶rslag...";
      document.getElementById('mReply').value = "";
      tModal.show();

      const res = await api(`/tickets/${id}`);
      if (!res) return;
      const currentGroup = String(res.ticket?.group || '').toUpperCase();
      document.getElementById('mGroup').value = currentGroup || 'SUPPORT';
      const badge = document.getElementById('mCurrentGroupBadge');
      badge.className = `group-badge ${groupClass(currentGroup)}`;
      badge.innerText = currentGroup || '-';
      await loadAssignableUsers();
      document.getElementById('mAssignee').value = res.ticket?.owner_email || '';
      document.getElementById('mHistory').innerHTML = res.messages.map(m => `
        <div class="msg-bubble shadow-sm">
          <div class="msg-header">
            <span class="fw-bold">${esc(m.from)}</span>
            <span class="text-muted">${new Date(m.date).toLocaleString()}</span>
          </div>
          <div class="small" style="white-space:pre-wrap;">${esc(m.body)}</div>
        </div>`).join('');

      if (res.messages && res.messages.length > 0) {
        const lastMsgText = res.messages[res.messages.length - 1].body;
        if (lastMsgText && lastMsgText !== "Ingen text tillgÃ¤nglig.") {
          if (!geminiConfigured) {
            document.getElementById('mAi').innerText = "AI inte konfigurerad: OPENAI_API_KEY saknas.";
          } else {
            try {
              const ai = await api('/ai/gemini', { method: 'POST', body: JSON.stringify({ text: lastMsgText }) });
              if (ai && ai.text) {
                document.getElementById('mAi').innerText = ai.text;
                document.getElementById('mReply').value = ai.text;
              } else {
                document.getElementById('mAi').innerText = "AI svarade tomt. Kontrollera model/API-instÃ¤llning.";
              }
            } catch (err) {
              document.getElementById('mAi').innerText = `AI-fel: ${err.message}`;
            }
          }
        } else {
          document.getElementById('mAi').innerText = "Kunde inte lÃ¤sa innehÃ¥llet fÃ¶r AI-fÃ¶rslag.";
        }
      }
    }

    function closeModalCleanly() { tModal.hide(); refresh(); }

    async function doReply() {
      const reply = document.getElementById('mReply').value;
      if (!reply) return alert("VÃ¤nligen skriv ett svar.");
      await api(`/tickets/${activeId}/reply`, { method: 'POST', body: JSON.stringify({ text: reply }) });
      alert('Svar registrerat.');
      tModal.hide();
      refresh();
    }

    async function doMove() {
      const targetGroup = document.getElementById('mGroup').value;
      const assignee = document.getElementById('mAssignee').value;
      const assignmentTxt = assignee ? ` och tilldela ${assignee}` : '';
      if (confirm(`Flytta till ${targetGroup}${assignmentTxt}?`)) {
        await api(`/tickets/${activeId}/move`, { method: 'POST', body: JSON.stringify({ group: targetGroup, owner_email: assignee || null }) });
        tModal.hide();
        refresh();
      }
    }

    document.getElementById('mGroup').addEventListener('change', async (e) => {
      const grp = String(e.target.value || '').toUpperCase();
      const badge = document.getElementById('mCurrentGroupBadge');
      badge.className = `group-badge ${groupClass(grp)}`;
      badge.innerText = grp || '-';
    });

    async function doBlock() {
      if (confirm(`Blockera ${currentSenderEmail}?`)) {
        await api(`/tickets/${activeId}/block`, { method: 'POST', body: JSON.stringify({ email: currentSenderEmail }) });
        tModal.hide();
        refresh();
      }
    }

    async function doDelete() {
      await api(`/tickets/${activeId}/status`, { method: 'POST', body: JSON.stringify({ status: 'LÃ¶st' }) });
      tModal.hide();
      refresh();
    }
  </script>
</body>
</html>
