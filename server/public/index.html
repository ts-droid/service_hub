<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --brand-primary: #DF3314;
      --brand-primary-dark: #95220D;
      --ink: #000;
      --muted: #666;
      --bg: #f7f7f7;
      --card: #fff;
      --line: #E2E2E2;
      --shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
    }
    body { background: var(--bg); font-family: "Avenir Next", Avenir, "Open Sans", Helvetica, Arial, sans-serif; color: var(--ink); }
    .top-nav { background: #000; border-bottom: 2px solid #111; }
    .navbar-brand { letter-spacing: 0.2px; }
    .ticket-card { border-left: 5px solid var(--brand-primary); cursor: pointer; transition: 0.2s; position: relative; border-radius: 10px; background: var(--card); box-shadow: var(--shadow); }
    .ticket-card:hover { transform: translateX(4px); background: #fff; }
    .ticket-meta { font-size: 0.85rem; color: var(--muted); }
    .history-container { max-height: 350px; overflow-y: auto; background: #fff; border-radius: 10px; padding: 15px; border: 1px solid var(--line); }
    .ai-box { background: #fff7f5; border: 1px solid #f4c6bb; border-radius: 10px; padding: 15px; font-style: italic; color: #2f2f2f !important; }
    .locked-badge { font-size: 0.7rem; background: #ffec99; color: #862e12; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .group-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 999px; font-weight: 700; }
    .group-support { background: #e7f5ff; color: #1864ab; }
    .group-rma { background: #fff4e6; color: #d9480f; }
    .group-logistics { background: #ebfbee; color: #2b8a3e; }
    .group-finance { background: #eef2ff; color: #3730a3; }
    .group-marketing { background: #fff0f6; color: #a61e4d; }
    .group-sales { background: #f8f0fc; color: #862e9c; }
    .group-default { background: #f1f3f5; color: #495057; }
    .status-wait { background-color: #6f42c1 !important; color: white; }

    .priority-alert {
      position: absolute; top: 10px; right: 10px;
      background: #ff4136; color: white; font-size: 0.65rem;
      padding: 2px 8px; border-radius: 10px; font-weight: bold;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .main-tabs { padding: 10px; gap: 8px; }
    .main-tabs .nav-item { flex: 1 1 0; }
    .main-tabs .nav-link {
      cursor: pointer;
      color: #333;
      font-weight: 700;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 14px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .main-tabs .nav-link.active {
      color: var(--brand-primary);
      border-color: var(--brand-primary);
      background: #fff3f0;
      box-shadow: inset 0 0 0 1px rgba(223, 51, 20, 0.14);
    }
    .tab-count {
      min-width: 30px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.78rem;
      font-weight: 700;
      text-align: center;
      background: #f1f3f5;
      color: #495057;
    }
    .main-tabs .nav-link.active .tab-count {
      background: var(--brand-primary);
      color: #fff;
    }

    .msg-bubble { margin-bottom: 15px; padding: 10px; border-radius: 10px; background: #fafafa; border: 1px solid var(--line); }
    .msg-header { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 5px; color: var(--brand-primary); }
    .keyword-panel { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 10px; margin-bottom: 12px; }
    .keyword-chip { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #fff4e6; color: #d9480f; font-size: 0.75rem; font-weight: 700; margin-right: 6px; margin-bottom: 6px; }
    .keyword-hit { background: #fff3bf; padding: 0 2px; border-radius: 3px; }
    .btn-primary { background: var(--brand-primary); border-color: var(--brand-primary); font-weight: 700; }
    .btn-primary:hover { background: var(--brand-primary-dark); border-color: var(--brand-primary-dark); }
    .btn-warning { background: var(--brand-primary); border-color: var(--brand-primary); color: #fff; font-weight: 800; }
    .form-control, .form-select { border-color: var(--line); }
    .form-control:focus, .form-select:focus {
      border-color: #ef9d8d;
      box-shadow: 0 0 0 0.2rem rgba(223, 51, 20, 0.15);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark top-nav p-3 shadow-sm">
    <div class="container d-flex justify-content-between">
      <span class="navbar-brand fw-bold">Vendora Support Hub</span>
      <div id="topActions" class="d-flex gap-2"></div>
    </div>
  </nav>

  <div class="container mt-4">
    <ul class="nav nav-tabs mb-4 border-0 shadow-sm bg-white rounded main-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-status="Nytt" onclick="setTab(this, 'Nytt')"><span>Nytt</span><span id="countNytt" class="tab-count">0</span></a></li>
      <li class="nav-item"><a class="nav-link" data-status="Mina P√•g√•ende" onclick="setTab(this, 'Mina P√•g√•ende')"><span>Mina P√•g√•ende</span><span id="countMinaPagaende" class="tab-count">0</span></a></li>
      <li class="nav-item"><a class="nav-link" data-status="Andras P√•g√•ende" onclick="setTab(this, 'Andras P√•g√•ende')"><span>Andras P√•g√•ende</span><span id="countAndrasPagaende" class="tab-count">0</span></a></li>
      <li class="nav-item"><a class="nav-link" data-status="L√∂st" onclick="setTab(this, 'L√∂st')"><span>L√∂st</span><span id="countLost" class="tab-count">0</span></a></li>
    </ul>

    <div class="row g-2 mb-3 align-items-center">
      <div class="col-md-4">
        <label class="small fw-bold text-muted ms-1">Filter Grupp:</label>
        <select id="filterGroup" class="form-select shadow-sm" onchange="refresh()"></select>
      </div>
      <div class="col-md-2 mt-auto">
        <button class="btn btn-primary w-100 shadow-sm" onclick="refresh()">Uppdatera</button>
      </div>
      <div class="col-md-3 mt-auto">
        <button class="btn btn-outline-primary w-100 shadow-sm" onclick="openManualTicketModal()">Nytt manuellt √§rende</button>
      </div>
    </div>

    <div id="ticketContainer" class="row">Laddar √§renden...</div>
  </div>

  <div class="modal fade" id="manualTicketModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title fw-bold">Skapa manuellt √§rende</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="small fw-bold text-muted">√Ñmne</label>
            <input id="manualSubject" class="form-control" placeholder="Kort √§mne">
          </div>
          <div class="mb-2">
            <label class="small fw-bold text-muted">Grupp</label>
            <select id="manualGroup" class="form-select">
              <option value="SUPPORT">SUPPORT</option>
              <option value="RMA">RMA</option>
              <option value="FINANCE">FINANCE</option>
              <option value="LOGISTICS">LOGISTICS</option>
              <option value="MARKETING">MARKETING</option>
              <option value="SALES">SALES</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="small fw-bold text-muted">Namn</label>
            <input id="manualContactName" class="form-control" placeholder="Ex: Anna Andersson">
          </div>
          <div class="mb-2">
            <label class="small fw-bold text-muted">Telefonnummer</label>
            <input id="manualContactPhone" class="form-control" placeholder="Ex: +46 70 123 45 67">
          </div>
          <div class="mb-2">
            <label class="small fw-bold text-muted">Mail</label>
            <input id="manualContactEmail" class="form-control" placeholder="Ex: anna@kund.se">
          </div>
          <div>
            <label class="small fw-bold text-muted">Beskrivning</label>
            <textarea id="manualBody" class="form-control" rows="5" placeholder="Vad g√§ller √§rendet?"></textarea>
          </div>
        </div>
        <div class="modal-footer bg-light border-0">
          <button class="btn btn-primary w-100 fw-bold" onclick="createManualTicket()">Skapa √§rende</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="ticketModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg border-0">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title fw-bold" id="mSubject">√Ñrende</h5>
          <button type="button" class="btn-close" onclick="closeModalCleanly()"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-start mb-4 p-2 bg-light rounded">
            <div class="d-flex flex-column gap-2">
              <div class="d-flex gap-2 align-items-center">
                <span class="small fw-bold text-muted">Flytta till:</span>
                <select id="mGroup" class="form-select form-select-sm w-auto">
                  <option value="SUPPORT">SUPPORT</option>
                  <option value="RMA">RMA</option>
                  <option value="FINANCE">FINANCE</option>
                  <option value="LOGISTICS">LOGISTICS</option>
                  <option value="MARKETING">MARKETING</option>
                  <option value="SALES">SALES</option>
                </select>
                <span id="mCurrentGroupBadge" class="group-badge group-default">-</span>
                <button class="btn btn-sm btn-primary" onclick="doMoveGroup()">Flytta</button>
              </div>
              <div class="d-flex gap-2 align-items-center">
                <span class="small fw-bold text-muted">Tilldela:</span>
                <select id="mAssignee" class="form-select form-select-sm w-auto"></select>
                <button class="btn btn-sm btn-outline-primary" onclick="doAssign()">Tilldela</button>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-danger btn-sm" onclick="doBlock()">Blockera</button>
              <button class="btn btn-outline-success btn-sm" onclick="doDelete()">Markera L√∂st</button>
            </div>
          </div>

          <div id="mHistory" class="history-container mb-3 shadow-sm"></div>
          <div id="mClassification" class="keyword-panel"></div>

          <label class="small fw-bold mb-1 text-primary">Svar (OpenAI-f√∂rslag fylls i h√§r):</label>
          <textarea id="mReply" class="form-control shadow-sm mb-2" rows="8" placeholder="OpenAI analyserar och fyller i svar..."></textarea>
          <div class="mb-2">
            <label class="small fw-bold text-muted mb-1">Bifoga filer</label>
            <input id="mAttachments" type="file" class="form-control" multiple onchange="renderAttachmentList()">
            <div id="mAttachmentList" class="small text-muted mt-1"></div>
          </div>
        </div>
        <div class="modal-footer bg-light border-0">
          <button class="btn btn-success w-100 fw-bold shadow-sm p-3" onclick="doReply()">SKICKA SVAR</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const esc = (s) => String(s || "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    let activeId = null;
    let currentSenderEmail = "";
    let currentStatusTab = "Nytt";
    let geminiConfigured = false;
    let currentUserGroups = [];
    let assignableUsers = [];
    let isAdminUser = false;
    let editableKeywordGroups = [];
    let currentClassification = { matchedByGroup: {} };
    let currentMessageForClassification = { subject: '', body: '' };
    let keywordConfigMap = {};
    const tModal = new bootstrap.Modal(document.getElementById('ticketModal'));
    const manualModal = new bootstrap.Modal(document.getElementById('manualTicketModal'));
    const formatDateTime = (v) => {
      if (!v) return "";
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString('sv-SE');
    };
    const groupClass = (group) => {
      const g = String(group || '').toUpperCase();
      if (g === 'SUPPORT') return 'group-support';
      if (g === 'RMA') return 'group-rma';
      if (g === 'LOGISTICS') return 'group-logistics';
      if (g === 'FINANCE') return 'group-finance';
      if (g === 'MARKETING') return 'group-marketing';
      if (g === 'SALES') return 'group-sales';
      return 'group-default';
    };
    const configKeyForGroup = (group) => `KEYWORDS_${String(group || '').toUpperCase()}`;

    async function api(path, opts = {}) {
      const res = await fetch(path, { ...opts, credentials: 'include', headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) } });
      if (res.status === 401) {
        window.location.href = '/auth/google';
        return null;
      }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Request failed');
      }
      return res.json();
    }

    window.onload = async () => {
      const me = await api('/me');
      if (!me) return;
      geminiConfigured = !!me.geminiConfigured;
      isAdminUser = !!me.isAdmin;
      currentUserGroups = String(me.group || '').split(',').map(s => s.trim()).filter(Boolean);
      const actions = [];
      if (me.isAdmin) {
        actions.push(`<a href="/admin" class="btn btn-warning btn-sm fw-bold shadow-sm">Admin</a>`);
      }
      actions.push(`<a href="/auth/logout" class="btn btn-outline-light btn-sm fw-bold shadow-sm">Logga ut</a>`);
      document.getElementById('topActions').innerHTML = actions.join('');
      syncManualGroupOptions();
      loadFilters();
    };

    async function loadKeywordConfigMap() {
      const data = await api('/keywords');
      if (!data) return;
      editableKeywordGroups = data.editableGroups || [];
      keywordConfigMap = data.keywords || {};
    }

    function keywordMatches(content, keyword) {
      const kw = String(keyword || '').trim();
      if (!kw) return false;
      const escaped = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const pattern = new RegExp(`(^|[^\\p{L}\\p{N}])(${escaped})(?=[^\\p{L}\\p{N}]|$)`, 'giu');
      return pattern.test(String(content || ''));
    }

    function highlightKeywords(text, keywords) {
      let html = esc(text || '');
      for (const kw of keywords || []) {
        if (!kw) continue;
        const escaped = esc(kw).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const pattern = new RegExp(`(^|[^\\p{L}\\p{N}])(${escaped})(?=[^\\p{L}\\p{N}]|$)`, 'giu');
        html = html.replace(pattern, (m, p1, p2) => `${p1}<span class="keyword-hit">${p2}</span>`);
      }
      return html;
    }

    function parseKeywords(value) {
      return String(value || '').split(',').map(s => s.trim()).filter(Boolean);
    }

    function canEditGroupKeywords(group) {
      const grp = String(group || '').toUpperCase();
      return editableKeywordGroups.includes(grp);
    }

    function getMatchedForGroup(group) {
      const fromBackend = currentClassification?.matchedByGroup?.[group] || [];
      if (fromBackend.length) return fromBackend;
      const key = configKeyForGroup(group);
      const keywords = parseKeywords(keywordConfigMap[key]);
      const content = `${currentMessageForClassification.subject || ''} ${currentMessageForClassification.body || ''}`;
      return keywords.filter(k => keywordMatches(content, k));
    }

    function renderClassificationPanel(group) {
      const box = document.getElementById('mClassification');
      const grp = String(group || '').toUpperCase();
      const matched = getMatchedForGroup(grp);
      const editableLabel = editableKeywordGroups.length
        ? editableKeywordGroups.join(', ')
        : 'Inga';
      const chips = matched.length
        ? matched.map(k => `<span class="keyword-chip">${esc(k)}</span>`).join('')
        : '<span class="text-muted small">Inga matchade keywords f√∂r vald grupp.</span>';

      const canEdit = canEditGroupKeywords(grp);
      const controlsLabel = canEdit
        ? `<div class="text-muted small mt-1">Du kan redigera: <strong>${esc(editableLabel)}</strong></div>`
        : `<div class="text-muted small mt-1">Du kan redigera: <strong>${esc(editableLabel)}</strong>. ${esc(grp)} √§r l√•st f√∂r ditt konto.</div>`;
      const adminControls = canEdit
        ? `<div class="d-flex gap-2 mt-2">
            <input id="mKeywordInput" class="form-control form-control-sm" placeholder="keyword">
            <button class="btn btn-sm btn-outline-primary" onclick="updateKeywordForCurrentGroup('add')">+</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="updateKeywordForCurrentGroup('remove')">-</button>
          </div>`
        : '';

      box.innerHTML = `
        <div class="small fw-bold text-muted mb-1">Klassificering (${esc(grp || '-')})</div>
        <div>${chips}</div>
        ${controlsLabel}
        ${adminControls}
      `;
    }

    async function updateKeywordForCurrentGroup(action) {
      const group = String(document.getElementById('mGroup').value || '').toUpperCase();
      if (!canEditGroupKeywords(group)) return;
      const key = configKeyForGroup(group);
      const input = document.getElementById('mKeywordInput');
      const term = String(input?.value || '').trim();
      if (!term) return;
      const res = await api(`/keywords/${encodeURIComponent(group)}`, {
        method: 'POST',
        body: JSON.stringify({ action, keyword: term })
      });
      if (!res) return;
      keywordConfigMap[key] = res.value || '';
      if (input) input.value = '';
      renderClassificationPanel(group);
    }

    function setTab(el, status) {
      document.querySelectorAll('#mainTabs .nav-link').forEach(link => link.classList.remove('active'));
      el.classList.add('active');
      currentStatusTab = status;
      refresh();
    }

    async function loadFilters() {
      const data = await api('/groups');
      if (!data) return;
      document.getElementById('filterGroup').innerHTML = data.groups.map(g => `<option value="${g}">${esc(g)}</option>`).join('');
      if (currentUserGroups.length === 1) {
        const onlyGroup = currentUserGroups[0].toUpperCase();
        const select = document.getElementById('filterGroup');
        const hasOption = Array.from(select.options).some(o => String(o.value).toUpperCase() === onlyGroup);
        if (hasOption) select.value = onlyGroup;
      }
      await loadKeywordConfigMap();
      await refresh();
    }

    async function refreshTabCounts() {
      const group = document.getElementById('filterGroup').value;
      const qs = new URLSearchParams({ group }).toString();
      const stats = await api(`/tickets/stats?${qs}`);
      if (!stats) return;
      document.getElementById('countNytt').innerText = stats['Nytt'] || 0;
      document.getElementById('countMinaPagaende').innerText = stats['Mina P√•g√•ende'] || 0;
      document.getElementById('countAndrasPagaende').innerText = stats['Andras P√•g√•ende'] || 0;
      document.getElementById('countLost').innerText = stats['L√∂st'] || 0;
    }

    async function refresh() {
      const filters = { group: document.getElementById('filterGroup').value, status: currentStatusTab };
      const qs = new URLSearchParams(filters).toString();
      const [tickets] = await Promise.all([
        api(`/tickets?${qs}`),
        refreshTabCounts()
      ]);
      if (!tickets) return;

      const container = document.getElementById('ticketContainer');
      if (!tickets.length) {
        container.innerHTML = '<div class="text-center p-5 text-muted"><h4>üéâ</h4>Inga √§renden h√§r just nu.</div>';
        return;
      }
      container.innerHTML = tickets.map(t => `
        <div class="col-12 mb-2">
          <div class="card p-3 shadow-sm border-0 ticket-card" onclick="openTicket('${esc(t.ID)}', '${esc(t.Subject)}', '${esc(t.Sender)}')">
            ${t.Priority === 'NYTT SVAR' ? '<div class="priority-alert">NYTT SVAR</div>' : ''}
            <div class="d-flex justify-content-between align-items-center">
              <div class="pe-5">
                <h6 class="mb-1 fw-bold">${esc(t.Subject)}</h6>
                <div class="ticket-meta">
                  <span class="text-dark fw-medium">${esc(t.Sender)}</span> ‚Ä¢ ${esc(t.ID)}
                  ${t.CreatedAt ? `<span class="ms-2">‚Ä¢ Inkommen: ${esc(formatDateTime(t.CreatedAt))}</span>` : ''}
                  ${t.Group ? `<span class="ms-2 group-badge ${groupClass(t.Group)}">${esc(t.Group)}</span>` : ''}
                  ${t.Owner ? `<span class="ms-2 locked-badge">üîí ${esc(t.Owner.split('@')[0])}</span>` : ''}
                </div>
              </div>
              <div class="badge ${t.Status === 'P√•g√•r' ? 'bg-warning text-dark' : (t.Status === 'V√§ntar' ? 'status-wait' : 'bg-primary')} shadow-sm">${esc(t.Status)}</div>
            </div>
          </div>
        </div>`).join('');
    }

    function openManualTicketModal() {
      const userGroup = (currentUserGroups[0] || 'SUPPORT').toUpperCase();
      document.getElementById('manualSubject').value = '';
      document.getElementById('manualContactName').value = '';
      document.getElementById('manualContactPhone').value = '';
      document.getElementById('manualContactEmail').value = '';
      document.getElementById('manualBody').value = '';
      document.getElementById('manualGroup').value = userGroup;
      manualModal.show();
    }

    function syncManualGroupOptions() {
      const select = document.getElementById('manualGroup');
      if (!select) return;
      const allowed = new Set(currentUserGroups.map((g) => String(g).toUpperCase()));
      Array.from(select.options).forEach((opt) => {
        opt.disabled = !isAdminUser && !allowed.has(String(opt.value).toUpperCase());
      });
      const firstEnabled = Array.from(select.options).find((opt) => !opt.disabled);
      if (firstEnabled) select.value = firstEnabled.value;
    }

    async function createManualTicket() {
      const subject = document.getElementById('manualSubject').value.trim();
      const group = document.getElementById('manualGroup').value;
      const contactName = document.getElementById('manualContactName').value.trim();
      const contactPhone = document.getElementById('manualContactPhone').value.trim();
      const contactEmail = document.getElementById('manualContactEmail').value.trim();
      const body = document.getElementById('manualBody').value.trim();

      if (!subject) return alert('Ange √§mne.');
      if (!body) return alert('Ange beskrivning.');
      if (!contactName && !contactPhone && !contactEmail) return alert('Ange minst en kontaktuppgift (namn, telefon eller mail).');

      const created = await api('/tickets/manual', {
        method: 'POST',
        body: JSON.stringify({ subject, group, contact_name: contactName, contact_phone: contactPhone, contact_email: contactEmail, body })
      });
      if (!created) return;
      manualModal.hide();
      await refresh();
      alert(`√Ñrende skapat: ${created.ticket_id}`);
    }

    async function loadAssignableUsers() {
      const users = await api('/users/assignees');
      if (!users) return;
      assignableUsers = users;
      const select = document.getElementById('mAssignee');
      const options = ['<option value="">Ej tilldelad</option>'].concat(
        users.map(u => `<option value="${esc(u.email)}">${esc(u.name || u.email)} (${esc(u.email)})</option>`)
      );
      select.innerHTML = options.join('');
    }

    async function openTicket(id, subject, sender) {
      activeId = id;
      currentSenderEmail = sender;
      document.getElementById('mSubject').innerText = subject;
      document.getElementById('mHistory').innerHTML = '<div class="p-3 text-center text-muted">Laddar historik...</div>';
      document.getElementById('mReply').value = "";
      document.getElementById('mReply').placeholder = "OpenAI analyserar och fyller i svar...";
      document.getElementById('mAttachments').value = "";
      document.getElementById('mAttachmentList').innerHTML = "";
      document.getElementById('mClassification').innerHTML = '<span class="text-muted small">Analyserar klassificering...</span>';
      tModal.show();

      const res = await api(`/tickets/${id}`);
      if (!res) return;
      const currentGroup = String(res.ticket?.group || '').toUpperCase();
      document.getElementById('mGroup').value = currentGroup || 'SUPPORT';
      const badge = document.getElementById('mCurrentGroupBadge');
      badge.className = `group-badge ${groupClass(currentGroup)}`;
      badge.innerText = currentGroup || '-';
      await loadAssignableUsers();
      document.getElementById('mAssignee').value = res.ticket?.owner_email || '';
      currentClassification = res.ticket?.classification || { matchedByGroup: {} };
      const lastMsg = res.messages[res.messages.length - 1] || { subject: '', body: '' };
      currentMessageForClassification = { subject: lastMsg.subject || '', body: lastMsg.body || '' };
      document.getElementById('mHistory').innerHTML = res.messages.map(m => `
        <div class="msg-bubble shadow-sm">
          <div class="msg-header">
            <span class="fw-bold">${esc(m.from)}</span>
            <span class="text-muted">${new Date(m.date).toLocaleString()}</span>
          </div>
          <div class="small" style="white-space:pre-wrap;">${highlightKeywords(m.body, getMatchedForGroup(currentGroup))}</div>
        </div>`).join('');
      renderClassificationPanel(currentGroup);

      if (res.messages && res.messages.length > 0) {
        const lastMsgText = res.messages[res.messages.length - 1].body;
        if (lastMsgText && lastMsgText !== "Ingen text tillg√§nglig.") {
          if (!geminiConfigured) {
            document.getElementById('mReply').placeholder = "AI inte konfigurerad: OPENAI_API_KEY saknas.";
          } else {
            try {
              const ai = await api('/ai/gemini', { method: 'POST', body: JSON.stringify({ text: lastMsgText }) });
              if (ai && ai.text) {
                document.getElementById('mReply').value = ai.text;
              } else {
                document.getElementById('mReply').placeholder = "AI svarade tomt. Skriv svaret manuellt.";
              }
            } catch (err) {
              document.getElementById('mReply').placeholder = `AI-fel: ${err.message}`;
            }
          }
        } else {
          document.getElementById('mReply').placeholder = "Kunde inte l√§sa inneh√•llet f√∂r AI-f√∂rslag.";
        }
      }
    }

    function closeModalCleanly() { tModal.hide(); refresh(); }

    function renderAttachmentList() {
      const files = Array.from(document.getElementById('mAttachments').files || []);
      const list = document.getElementById('mAttachmentList');
      if (!files.length) {
        list.innerHTML = "";
        return;
      }
      list.innerHTML = files.map((f) => `${esc(f.name)} (${Math.round(f.size / 1024)} KB)`).join('<br>');
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = String(reader.result || '');
          const base64 = result.includes(',') ? result.split(',')[1] : result;
          resolve({
            filename: file.name,
            mimeType: file.type || 'application/octet-stream',
            dataBase64: base64
          });
        };
        reader.onerror = () => reject(new Error(`Kunde inte l√§sa fil: ${file.name}`));
        reader.readAsDataURL(file);
      });
    }

    async function doReply() {
      const reply = document.getElementById('mReply').value;
      if (!reply) return alert("V√§nligen skriv ett svar.");
      const files = Array.from(document.getElementById('mAttachments').files || []);
      if (files.length > 5) return alert('Max 5 bilagor.');
      const attachments = await Promise.all(files.map(fileToBase64));
      await api(`/tickets/${activeId}/reply`, { method: 'POST', body: JSON.stringify({ text: reply, attachments }) });
      alert('Svar registrerat.');
      tModal.hide();
      refresh();
    }

    async function doMoveGroup() {
      const targetGroup = document.getElementById('mGroup').value;
      if (confirm(`Flytta till ${targetGroup}? √Ñrendet blir ej tilldelat.`)) {
        await api(`/tickets/${activeId}/move`, { method: 'POST', body: JSON.stringify({ group: targetGroup }) });
        tModal.hide();
        refresh();
      }
    }

    async function doAssign() {
      const assignee = document.getElementById('mAssignee').value;
      const prompt = assignee ? `Tilldela √§rendet till ${assignee}?` : 'Ta bort tilldelning fr√•n √§rendet?';
      if (confirm(prompt)) {
        await api(`/tickets/${activeId}/assign`, { method: 'POST', body: JSON.stringify({ owner_email: assignee || null }) });
        tModal.hide();
        refresh();
      }
    }

    document.getElementById('mGroup').addEventListener('change', async (e) => {
      const grp = String(e.target.value || '').toUpperCase();
      const badge = document.getElementById('mCurrentGroupBadge');
      badge.className = `group-badge ${groupClass(grp)}`;
      badge.innerText = grp || '-';
      renderClassificationPanel(grp);
      const history = document.getElementById('mHistory');
      history.querySelectorAll('.msg-bubble .small').forEach((el, idx) => {
        // Re-rendering from existing textContent keeps escaping safe.
        const raw = el.textContent || '';
        el.innerHTML = highlightKeywords(raw, getMatchedForGroup(grp));
      });
    });

    async function doBlock() {
      if (confirm(`Blockera ${currentSenderEmail}?`)) {
        await api(`/tickets/${activeId}/block`, { method: 'POST', body: JSON.stringify({ email: currentSenderEmail }) });
        tModal.hide();
        refresh();
      }
    }

    async function doDelete() {
      await api(`/tickets/${activeId}/status`, { method: 'POST', body: JSON.stringify({ status: 'L√∂st' }) });
      tModal.hide();
      refresh();
    }
</script>
</body>
</html>
