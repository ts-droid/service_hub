<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --brand-primary: #DF3314;
      --brand-primary-dark: #95220D;
      --ink: #000;
      --muted: #666;
      --bg: #f7f7f7;
      --card: #fff;
      --line: #E2E2E2;
      --shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
    }
    body { background: var(--bg); font-family: "Avenir Next", Avenir, "Open Sans", Helvetica, Arial, sans-serif; color: var(--ink); }
    .top-nav { background: #000; border-bottom: 2px solid #111; }
    .card { border: 1px solid var(--line); border-radius: 12px; background: var(--card); box-shadow: var(--shadow); }
    .section-title { font-weight: 700; margin-bottom: 10px; }
    .muted { color: var(--muted); font-size: 0.85rem; }
    .user-row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--line); }
    .user-meta { font-size: 0.85rem; color: var(--muted); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 0.75rem; font-weight: 600; }
    .config-row { display: grid; grid-template-columns: 220px 1fr 120px; gap: 10px; align-items: center; }
    .btn-primary { background: var(--brand-primary); border-color: var(--brand-primary); font-weight: 700; }
    .btn-primary:hover { background: var(--brand-primary-dark); border-color: var(--brand-primary-dark); }
    .btn-warning { background: var(--brand-primary); border-color: var(--brand-primary); color: #fff; font-weight: 800; }
    .form-control, .form-select { border-color: var(--line); }
    .form-control:focus, .form-select:focus {
      border-color: #ef9d8d;
      box-shadow: 0 0 0 0.2rem rgba(223, 51, 20, 0.15);
    }
    @media (max-width: 992px) {
      .config-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark top-nav p-3 shadow-sm">
    <div class="container d-flex justify-content-between">
      <span class="navbar-brand fw-bold" data-i18n="brand_title">Vendora Support Hub</span>
      <div class="d-flex gap-2 align-items-center">
        <div class="btn-group btn-group-sm" role="group" aria-label="Language switch">
          <button id="langSvBtn" type="button" class="btn btn-outline-light" onclick="setLanguage('sv')">ðŸ‡¸ðŸ‡ª Svenska</button>
          <button id="langEnBtn" type="button" class="btn btn-outline-light" onclick="setLanguage('en')">ðŸ‡¬ðŸ‡§ English</button>
        </div>
        <div id="topActions" class="d-flex gap-2"></div>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row g-4">
      <div class="col-12">
        <div class="card p-4 shadow-sm">
          <div class="section-title" data-i18n="users_title">AnvÃ¤ndare</div>
          <div id="usersList" class="small text-muted" data-i18n="loading">Laddar...</div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card p-4 shadow-sm">
          <div class="section-title" data-i18n="settings_title">InstÃ¤llningar</div>
          <div class="mt-2">
            <label class="form-label fw-bold" data-i18n="keywords_all_rows">Keywords (alla rader)</label>
            <div id="keywordsList" class="d-grid gap-2"></div>
          </div>
        </div>
        <div class="card p-4 shadow-sm mt-4">
          <div class="section-title" data-i18n="signatures_title">Signaturer (gruppmail)</div>
          <label class="form-label fw-bold" data-i18n="select_group">VÃ¤lj grupp</label>
          <select id="signatureSelect" class="form-select mb-2"></select>
          <textarea id="signatureEditor" class="form-control" rows="7" data-i18n-placeholder="signature_placeholder" placeholder="Skriv signatur fÃ¶r vald grupp..."></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-primary" onclick="saveSelectedSignature()" data-i18n="save_signature_btn">Spara signatur</button>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-4 shadow-sm mb-4">
          <div class="section-title" data-i18n="sync_title">Synk</div>
          <div id="latestSyncInfo" class="muted mb-2" data-i18n="sync_latest_loading">Senaste synk: laddar...</div>
          <div class="muted mb-2" data-i18n="sync_desc">HÃ¤mtar nya Gmail-Ã¤renden till databasen</div>
          <button id="syncBtn" class="btn btn-primary w-100" onclick="runSync()" data-i18n="sync_now_btn">Synka nu</button>
          <div id="syncResult" class="muted mt-2"></div>
        </div>

        <div class="card p-4 shadow-sm mb-4">
          <div class="section-title" data-i18n="blacklist_title">Blacklist</div>
          <div class="muted mb-2" data-i18n="blacklist_pick">VÃ¤lj email fÃ¶r att avblockera</div>
          <select id="blacklistSelect" class="form-select mb-2"></select>
          <button class="btn btn-outline-success w-100" onclick="unblockSelected()" data-i18n="unblock_btn">Avblockera vald</button>
        </div>

        <div class="card p-4 shadow-sm">
          <div class="section-title" data-i18n="ai_prompt_title">AI Prompt</div>
          <label class="form-label fw-bold" data-i18n="prompt_label">Prompt</label>
          <textarea id="aiPrompt" class="form-control" rows="5" data-i18n-placeholder="prompt_placeholder" placeholder="Skriv ett vÃ¤nligt, kort och professionellt svar..."></textarea>
          <label class="form-label fw-bold mt-3" data-i18n="ai_rule_label">AI SprÃ¥kregel</label>
          <textarea id="aiLanguageRule" class="form-control" rows="4" data-i18n-placeholder="ai_rule_placeholder" placeholder="Ex: CRITICAL: Reply ONLY in {{LANGUAGE}} ..."></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-primary" onclick="saveAiSettings()" data-i18n="save_ai_btn">Spara AI-instÃ¤llningar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="edit_user_title">Redigera anvÃ¤ndare</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" data-i18n="email_label">Email</label>
            <input id="editEmail" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label" data-i18n="name_label">Namn</label>
            <input id="editName" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label" data-i18n="groups_label">Grupper (kommaseparerat)</label>
            <input id="editGroup" class="form-control" data-i18n-placeholder="groups_placeholder" placeholder="SUPPORT,RMA">
          </div>
          <div class="mb-3">
            <label class="form-label" data-i18n="slack_member_id_label">Slack Member ID</label>
            <input id="editSlackMemberId" class="form-control" data-i18n-placeholder="slack_member_id_placeholder" placeholder="U0123456789">
          </div>
          <div class="mb-3">
            <label class="form-label" data-i18n="role_label">Roll</label>
            <select id="editRole" class="form-select">
              <option value="User">User</option>
              <option value="Admin">Admin</option>
            </select>
          </div>
          <div class="form-check">
            <input id="editActive" class="form-check-input" type="checkbox" checked>
            <label class="form-check-label" data-i18n="active_label">Aktiv</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel_btn">Avbryt</button>
          <button class="btn btn-primary" onclick="saveUserEdit()" data-i18n="save_btn">Spara</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const I18N = {
      sv: {
        brand_title: 'Vendora Support Hub',
        back: 'Tillbaka',
        logout: 'Logga ut',
        users_title: 'AnvÃ¤ndare',
        loading: 'Laddar...',
        settings_title: 'InstÃ¤llningar',
        keywords_all_rows: 'Keywords (alla rader)',
        signatures_title: 'Signaturer (gruppmail)',
        select_group: 'VÃ¤lj grupp',
        signature_placeholder: 'Skriv signatur fÃ¶r vald grupp...',
        save_signature_btn: 'Spara signatur',
        sync_title: 'Synk',
        sync_latest_loading: 'Senaste synk: laddar...',
        sync_desc: 'HÃ¤mtar nya Gmail-Ã¤renden till databasen',
        sync_now_btn: 'Synka nu',
        syncing_btn: 'Synkar...',
        blacklist_title: 'Blacklist',
        blacklist_pick: 'VÃ¤lj email fÃ¶r att avblockera',
        unblock_btn: 'Avblockera vald',
        ai_prompt_title: 'AI Prompt',
        prompt_label: 'Prompt',
        prompt_placeholder: 'Skriv ett vÃ¤nligt, kort och professionellt svar...',
        ai_rule_label: 'AI SprÃ¥kregel',
        ai_rule_placeholder: 'Ex: CRITICAL: Reply ONLY in {{LANGUAGE}} ...',
        save_ai_btn: 'Spara AI-instÃ¤llningar',
        edit_user_title: 'Redigera anvÃ¤ndare',
        email_label: 'Email',
        name_label: 'Namn',
        groups_label: 'Grupper (kommaseparerat)',
        groups_placeholder: 'SUPPORT,RMA',
        slack_member_id_label: 'Slack Member ID',
        slack_member_id_placeholder: 'U0123456789',
        role_label: 'Roll',
        active_label: 'Aktiv',
        cancel_btn: 'Avbryt',
        save_btn: 'Spara',
        no_admin: 'Ingen adminbehÃ¶righet',
        no_groups: 'Inga grupper',
        edit_user_btn: 'Editera',
        delete_user_btn: 'Ta bort',
        fill_required: 'Fyll i namn, grupp och roll',
        slack_invalid: 'Ogiltigt Slack Member ID (mÃ¥ste bÃ¶rja med U).',
        remove_user_confirm: 'Ta bort {email}?',
        request_failed: 'Request failed',
        error_prefix: 'Fel',
        latest_sync_none: 'Senaste synk: ingen kÃ¶rning loggad Ã¤nnu.',
        latest_sync: 'Senaste synk: {ts} â€¢ {source}',
        signature_saved: 'Signatur sparad',
        ai_saved: 'AI-instÃ¤llningar sparade',
        saved: 'Sparat'
      },
      en: {
        brand_title: 'Vendora Support Hub',
        back: 'Back',
        logout: 'Log out',
        users_title: 'Users',
        loading: 'Loading...',
        settings_title: 'Settings',
        keywords_all_rows: 'Keywords (all rows)',
        signatures_title: 'Signatures (group mailboxes)',
        select_group: 'Select group',
        signature_placeholder: 'Write signature for selected group...',
        save_signature_btn: 'Save signature',
        sync_title: 'Sync',
        sync_latest_loading: 'Latest sync: loading...',
        sync_desc: 'Fetches new Gmail tickets into the database',
        sync_now_btn: 'Sync now',
        syncing_btn: 'Syncing...',
        blacklist_title: 'Blacklist',
        blacklist_pick: 'Choose email to unblock',
        unblock_btn: 'Unblock selected',
        ai_prompt_title: 'AI Prompt',
        prompt_label: 'Prompt',
        prompt_placeholder: 'Write a friendly, short, professional reply...',
        ai_rule_label: 'AI Language Rule',
        ai_rule_placeholder: 'Ex: CRITICAL: Reply ONLY in {{LANGUAGE}} ...',
        save_ai_btn: 'Save AI settings',
        edit_user_title: 'Edit user',
        email_label: 'Email',
        name_label: 'Name',
        groups_label: 'Groups (comma-separated)',
        groups_placeholder: 'SUPPORT,RMA',
        slack_member_id_label: 'Slack Member ID',
        slack_member_id_placeholder: 'U0123456789',
        role_label: 'Role',
        active_label: 'Active',
        cancel_btn: 'Cancel',
        save_btn: 'Save',
        no_admin: 'No admin access',
        no_groups: 'No groups',
        edit_user_btn: 'Edit',
        delete_user_btn: 'Delete',
        fill_required: 'Fill in name, group, and role',
        slack_invalid: 'Invalid Slack Member ID (must start with U).',
        remove_user_confirm: 'Delete {email}?',
        request_failed: 'Request failed',
        error_prefix: 'Error',
        latest_sync_none: 'Latest sync: no run logged yet.',
        latest_sync: 'Latest sync: {ts} â€¢ {source}',
        signature_saved: 'Signature saved',
        ai_saved: 'AI settings saved',
        saved: 'Saved'
      }
    };
    let currentLang = localStorage.getItem('supporthub_lang') || 'sv';
    const tr = (key, vars = {}) => {
      let s = (I18N[currentLang] && I18N[currentLang][key]) || I18N.sv[key] || key;
      Object.keys(vars).forEach((k) => { s = s.replace(`{${k}}`, vars[k]); });
      return s;
    };
    function renderTopActions() {
      document.getElementById('topActions').innerHTML =
        `<a class="btn btn-outline-light btn-sm" href="/">${tr('back')}</a>
        <a class="btn btn-outline-light btn-sm" href="/auth/logout">${tr('logout')}</a>`;
    }
    function applyI18n() {
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        el.textContent = tr(el.getAttribute('data-i18n'));
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
        el.setAttribute('placeholder', tr(el.getAttribute('data-i18n-placeholder')));
      });
      document.getElementById('langSvBtn').classList.toggle('btn-light', currentLang === 'sv');
      document.getElementById('langSvBtn').classList.toggle('btn-outline-light', currentLang !== 'sv');
      document.getElementById('langEnBtn').classList.toggle('btn-light', currentLang === 'en');
      document.getElementById('langEnBtn').classList.toggle('btn-outline-light', currentLang !== 'en');
    }
    function setLanguage(lang) {
      currentLang = lang === 'en' ? 'en' : 'sv';
      localStorage.setItem('supporthub_lang', currentLang);
      renderTopActions();
      applyI18n();
      loadUsers();
      loadBlacklist();
      loadLatestSync();
      loadConfig();
    }

    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    let editUserEmail = null;
    let blacklistIndex = new Map();
    let signatureValues = new Map();
    const defaultSignatureKeys = ['SIGNATURE_SUPPORT', 'SIGNATURE_RMA', 'SIGNATURE_FINANCE', 'SIGNATURE_LOGISTICS', 'SIGNATURE_MARKETING', 'SIGNATURE_SALES'];
    const jsq = (v) => JSON.stringify(String(v ?? ''));

    async function api(path, opts = {}) {
      const res = await fetch(path, { ...opts, credentials: 'include', headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) } });
      if (res.status === 401) {
        window.location.href = '/auth/google';
        return null;
      }
      if (res.status === 403) {
        alert(tr('no_admin'));
        window.location.href = '/';
        return null;
      }
      if (!res.ok) {
        const text = await res.text();
        try {
          const err = JSON.parse(text);
          throw new Error(`${res.status}: ${err.error || err.reason || tr('request_failed')}`);
        } catch (e) {
          throw new Error(`${res.status}: ${text || tr('request_failed')}`);
        }
      }
      return res.json();
    }

    async function loadUsers() {
      const users = await api('/admin/users');
      if (!users) return;
      document.getElementById('usersList').innerHTML = users.map(u => {
        const groups = (u.group || '').split(',').filter(Boolean).map(g => `<span class="pill me-1">${g.trim()}</span>`).join('');
        const slackMeta = u.slack_member_id ? ` â€¢ Slack: ${u.slack_member_id}` : '';
        return `
          <div class="user-row">
            <div>
              <div class="fw-bold">${u.name} <span class="text-muted">(${u.email})</span></div>
              <div class="user-meta">${groups || `<span class="muted">${tr('no_groups')}</span>`} â€¢ ${u.role}${slackMeta}</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick='openEdit(${jsq(u.email)}, ${jsq(u.name)}, ${jsq(u.group)}, ${jsq(u.role)}, ${u.active ? 'true' : 'false'}, ${jsq(u.slack_member_id || "")})'>${tr('edit_user_btn')}</button>
              <button class="btn btn-sm btn-outline-danger" onclick='delUser(${jsq(u.email)})'>${tr('delete_user_btn')}</button>
            </div>
          </div>`;
      }).join('');
    }

    function openEdit(email, name, group, role, active, slackMemberId) {
      editUserEmail = email;
      document.getElementById('editEmail').value = email;
      document.getElementById('editName').value = name || '';
      document.getElementById('editGroup').value = group || '';
      document.getElementById('editSlackMemberId').value = slackMemberId || '';
      document.getElementById('editRole').value = role || 'User';
      document.getElementById('editActive').checked = !!active;
      editModal.show();
    }

    async function saveUserEdit() {
      const name = document.getElementById('editName').value.trim();
      const group = document.getElementById('editGroup').value.trim();
      const role = document.getElementById('editRole').value;
      const slackMemberId = document.getElementById('editSlackMemberId').value.trim().toUpperCase();
      const active = document.getElementById('editActive').checked;
      if (!name || !group || !role) return alert(tr('fill_required'));
      if (slackMemberId && !/^U[A-Z0-9]+$/.test(slackMemberId)) return alert(tr('slack_invalid'));

      await api(`/admin/users/${encodeURIComponent(editUserEmail)}`, {
        method: 'PUT',
        body: JSON.stringify({ name, group, role, active, slack_member_id: slackMemberId || null })
      });
      editModal.hide();
      loadUsers();
    }

    async function delUser(email) {
      if (!confirm(tr('remove_user_confirm', { email }))) return;
      await api(`/admin/users/${encodeURIComponent(email)}`, { method: 'DELETE' });
      loadUsers();
    }

    async function loadBlacklist() {
      const list = await api('/admin/blacklist');
      if (!list) return;
      blacklistIndex = new Map(list.map(b => [b.email, b.blocked_at]));
      const select = document.getElementById('blacklistSelect');
      select.innerHTML = list.map(b => `<option value="${b.email}">${b.email} â€¢ ${new Date(b.blocked_at).toLocaleString(currentLang === 'en' ? 'en-GB' : 'sv-SE')}</option>`).join('');
    }

    async function unblockSelected() {
      const email = document.getElementById('blacklistSelect').value;
      if (!email) return;
      await api(`/admin/blacklist/${encodeURIComponent(email)}`, { method: 'DELETE' });
      loadBlacklist();
    }

    async function runSync() {
      const btn = document.getElementById('syncBtn');
      const resultBox = document.getElementById('syncResult');
      btn.disabled = true;
      btn.textContent = tr('syncing_btn');
      resultBox.textContent = '';
      try {
        await api('/admin/jobs/gmail-sync', { method: 'POST' });
        resultBox.textContent = '';
      } catch (err) {
        resultBox.textContent = `${tr('error_prefix')}: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = tr('sync_now_btn');
        loadLatestSync();
      }
    }

    async function loadLatestSync() {
      const box = document.getElementById('latestSyncInfo');
      const res = await api('/admin/jobs/gmail-sync/latest');
      if (!res || !res.latest) {
        box.textContent = tr('latest_sync_none');
        return;
      }
      const ts = new Date(res.latest.timestamp).toLocaleString(currentLang === 'en' ? 'en-GB' : 'sv-SE');
      box.textContent = tr('latest_sync', { ts, source: (res.latest.source || res.latest.user_email || 'CRON') });
    }

    async function loadConfig() {
      const rows = await api('/admin/config');
      if (!rows) return;
      const map = new Map(rows.map(r => [r.key, r.value]));
      document.getElementById('aiPrompt').value = map.get('AI_PROMPT') || '';
      document.getElementById('aiLanguageRule').value = map.get('AI_LANGUAGE_RULE') || '';

      const keywords = rows.filter(r => r.key.startsWith('KEYWORDS_'));
      document.getElementById('keywordsList').innerHTML = keywords.map(r => `
        <div class="config-row">
          <div class="fw-bold">${r.key}</div>
          <input class="form-control" id="cfg_${r.key}" value="${(r.value || '').replace(/"/g, '&quot;')}">
          <button class="btn btn-outline-primary" onclick="saveConfigKey('${r.key}')">${tr('save_btn')}</button>
        </div>`).join('');

      const signatures = rows.filter(r => r.key.startsWith('SIGNATURE_'));
      signatureValues = new Map(signatures.map(s => [s.key, s.value || '']));

      const signatureSelect = document.getElementById('signatureSelect');
      signatureSelect.innerHTML = defaultSignatureKeys
        .map((key) => `<option value="${key}">${key.replace('SIGNATURE_', '')}</option>`)
        .join('');
      if (!signatureSelect.dataset.bound) {
        signatureSelect.addEventListener('change', onSignatureSelectChange);
        signatureSelect.dataset.bound = '1';
      }
      onSignatureSelectChange();
    }

    function onSignatureSelectChange() {
      const key = document.getElementById('signatureSelect').value;
      document.getElementById('signatureEditor').value = signatureValues.get(key) || '';
    }

    async function saveSelectedSignature() {
      const key = document.getElementById('signatureSelect').value;
      const value = document.getElementById('signatureEditor').value.trim();
      await api('/admin/config', { method: 'POST', body: JSON.stringify({ key, value }) });
      signatureValues.set(key, value);
      alert(tr('signature_saved'));
    }

    async function saveAiSettings() {
      const prompt = document.getElementById('aiPrompt').value.trim();
      const languageRule = document.getElementById('aiLanguageRule').value.trim();
      await api('/admin/config', { method: 'POST', body: JSON.stringify({ key: 'AI_PROMPT', value: prompt }) });
      await api('/admin/config', { method: 'POST', body: JSON.stringify({ key: 'AI_LANGUAGE_RULE', value: languageRule }) });
      alert(tr('ai_saved'));
    }

    async function saveConfigKey(key) {
      const value = document.getElementById(`cfg_${key}`).value.trim();
      await api('/admin/config', { method: 'POST', body: JSON.stringify({ key, value }) });
      alert(tr('saved'));
    }

    renderTopActions();
    applyI18n();
    loadUsers();
    loadConfig();
    loadBlacklist();
    loadLatestSync();
  </script>
</body>
</html>
