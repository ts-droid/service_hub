<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f6f7fb; font-family: 'Segoe UI', sans-serif; }
    .card { border: none; border-radius: 12px; }
    .section-title { font-weight: 700; margin-bottom: 10px; }
    .muted { color: #6c757d; font-size: 0.85rem; }
    .user-row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
    .user-meta { font-size: 0.85rem; color: #6c757d; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 0.75rem; font-weight: 600; }
    .config-row { display: grid; grid-template-columns: 220px 1fr 120px; gap: 10px; align-items: center; }
    @media (max-width: 992px) {
      .config-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark p-3 shadow-sm">
    <div class="container d-flex justify-content-between">
      <span class="navbar-brand fw-bold">Vendora Support Hub</span>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="/">Tillbaka</a>
        <a class="btn btn-outline-light btn-sm" href="/auth/logout">Logga ut</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row g-4">
      <div class="col-12">
        <div class="card p-4 shadow-sm">
          <div class="section-title">Användare</div>
          <div id="usersList" class="small text-muted">Laddar...</div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card p-4 shadow-sm">
          <div class="section-title">Inställningar</div>
          <div class="mt-2">
            <label class="form-label fw-bold">Keywords (alla rader)</label>
            <div id="keywordsList" class="d-grid gap-2"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-4 shadow-sm mb-4">
          <div class="section-title">Synk</div>
          <div class="muted mb-2">Hämtar nya Gmail-ärenden till databasen</div>
          <button id="syncBtn" class="btn btn-primary w-100" onclick="runSync()">Synka nu</button>
          <div id="syncResult" class="muted mt-2"></div>
        </div>

        <div class="card p-4 shadow-sm mb-4">
          <div class="section-title">Blacklist</div>
          <div class="muted mb-2">Välj email för att avblockera</div>
          <select id="blacklistSelect" class="form-select mb-2"></select>
          <button class="btn btn-outline-success w-100" onclick="unblockSelected()">Avblockera vald</button>
        </div>

        <div class="card p-4 shadow-sm">
          <div class="section-title">AI Prompt</div>
          <textarea id="aiPrompt" class="form-control" rows="5" placeholder="Skriv ett vänligt, kort och professionellt svar..."></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-primary" onclick="saveAiPrompt()">Spara AI Prompt</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Redigera användare</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="editEmail" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">Namn</label>
            <input id="editName" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Grupper (kommaseparerat)</label>
            <input id="editGroup" class="form-control" placeholder="SUPPORT,RMA">
          </div>
          <div class="mb-3">
            <label class="form-label">Roll</label>
            <select id="editRole" class="form-select">
              <option value="User">User</option>
              <option value="Admin">Admin</option>
            </select>
          </div>
          <div class="form-check">
            <input id="editActive" class="form-check-input" type="checkbox" checked>
            <label class="form-check-label">Aktiv</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
          <button class="btn btn-primary" onclick="saveUserEdit()">Spara</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    let editUserEmail = null;
    let blacklistIndex = new Map();

    async function api(path, opts = {}) {
      const res = await fetch(path, { ...opts, credentials: 'include', headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) } });
      if (res.status === 401) {
        window.location.href = '/auth/google';
        return null;
      }
      if (res.status === 403) {
        alert('Ingen adminbehörighet');
        window.location.href = '/';
        return null;
      }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Request failed');
      }
      return res.json();
    }

    async function loadUsers() {
      const users = await api('/admin/users');
      if (!users) return;
      document.getElementById('usersList').innerHTML = users.map(u => {
        const groups = (u.group || '').split(',').filter(Boolean).map(g => `<span class="pill me-1">${g.trim()}</span>`).join('');
        return `
          <div class="user-row">
            <div>
              <div class="fw-bold">${u.name} <span class="text-muted">(${u.email})</span></div>
              <div class="user-meta">${groups || '<span class="muted">Inga grupper</span>'} • ${u.role}</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="openEdit('${u.email}', '${u.name}', '${u.group}', '${u.role}', ${u.active})">Editera</button>
              <button class="btn btn-sm btn-outline-danger" onclick="delUser('${u.email}')">Ta bort</button>
            </div>
          </div>`;
      }).join('');
    }

    function openEdit(email, name, group, role, active) {
      editUserEmail = email;
      document.getElementById('editEmail').value = email;
      document.getElementById('editName').value = name || '';
      document.getElementById('editGroup').value = group || '';
      document.getElementById('editRole').value = role || 'User';
      document.getElementById('editActive').checked = !!active;
      editModal.show();
    }

    async function saveUserEdit() {
      const name = document.getElementById('editName').value.trim();
      const group = document.getElementById('editGroup').value.trim();
      const role = document.getElementById('editRole').value;
      const active = document.getElementById('editActive').checked;
      if (!name || !group || !role) return alert('Fyll i namn, grupp och roll');

      await api(`/admin/users/${encodeURIComponent(editUserEmail)}`, {
        method: 'PUT',
        body: JSON.stringify({ name, group, role, active })
      });
      editModal.hide();
      loadUsers();
    }

    async function delUser(email) {
      if (!confirm(`Ta bort ${email}?`)) return;
      await api(`/admin/users/${encodeURIComponent(email)}`, { method: 'DELETE' });
      loadUsers();
    }

    async function loadBlacklist() {
      const list = await api('/admin/blacklist');
      if (!list) return;
      blacklistIndex = new Map(list.map(b => [b.email, b.blocked_at]));
      const select = document.getElementById('blacklistSelect');
      select.innerHTML = list.map(b => `<option value="${b.email}">${b.email} • ${new Date(b.blocked_at).toLocaleString()}</option>`).join('');
    }

    async function unblockSelected() {
      const email = document.getElementById('blacklistSelect').value;
      if (!email) return;
      await api(`/admin/blacklist/${encodeURIComponent(email)}`, { method: 'DELETE' });
      loadBlacklist();
    }

    async function runSync() {
      const btn = document.getElementById('syncBtn');
      const resultBox = document.getElementById('syncResult');
      btn.disabled = true;
      btn.textContent = 'Synkar...';
      resultBox.textContent = '';
      try {
        const res = await api('/admin/jobs/gmail-sync', { method: 'POST' });
        const details = res.stats
          ? ` | users: ${res.stats.usersScanned}, listade: ${res.stats.threadsListed}, hämtade: ${res.stats.threadsFetched}, skip-internal: ${res.stats.skippedInternalSender}, skip-no-group: ${res.stats.skippedNoGroup}, skip-existing: ${res.stats.skippedExistingThread}, list-errors: ${res.stats.userListErrors}, thread-errors: ${res.stats.threadFetchErrors}`
          : '';
        const startInfo = res.startTimeUsed
          ? ` Start: ${res.startTimeUsed} (${res.startTimeReason || 'unknown'}).`
          : '';
        const errorDetail = (res.stats?.userListErrorDetails || []).length
          ? ` Gmail-fel: ${res.stats.userListErrorDetails.map(e => `${e.email}: ${e.error}`).join(' | ')}`
          : '';
        resultBox.textContent = `Klar. Skapade ${res.created || 0} nya ärenden.${details}${startInfo}${errorDetail}`;
      } catch (err) {
        resultBox.textContent = `Fel: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Synka nu';
      }
    }

    async function loadConfig() {
      const rows = await api('/admin/config');
      if (!rows) return;
      const map = new Map(rows.map(r => [r.key, r.value]));
      document.getElementById('aiPrompt').value = map.get('AI_PROMPT') || '';

      const keywords = rows.filter(r => r.key.startsWith('KEYWORDS_'));
      document.getElementById('keywordsList').innerHTML = keywords.map(r => `
        <div class="config-row">
          <div class="fw-bold">${r.key}</div>
          <input class="form-control" id="cfg_${r.key}" value="${(r.value || '').replace(/"/g, '&quot;')}">
          <button class="btn btn-outline-primary" onclick="saveConfigKey('${r.key}')">Spara</button>
        </div>`).join('');
    }

    async function saveAiPrompt() {
      const value = document.getElementById('aiPrompt').value.trim();
      await api('/admin/config', { method: 'POST', body: JSON.stringify({ key: 'AI_PROMPT', value }) });
      alert('AI Prompt sparad');
    }

    async function saveConfigKey(key) {
      const value = document.getElementById(`cfg_${key}`).value.trim();
      await api('/admin/config', { method: 'POST', body: JSON.stringify({ key, value }) });
      alert('Sparat');
    }

    loadUsers();
    loadConfig();
    loadBlacklist();
  </script>
</body>
</html>
